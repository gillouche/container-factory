name: Build & Publish

on:
  push:
    branches: [ "**" ]
    paths:
      - "images/**"
      - "ci/**"
      - "tests/**"
      - ".github/workflows/**"
      - "Makefile"
      - "flake.nix"
      - "flake.lock"
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *' # Nightly rebuild at 3 AM UTC

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  prepare:
    name: Prepare Matrices
    runs-on: container-factory-runner
    outputs:
      matrix-l1: ${{ steps.set-matrix-l1.outputs.matrix }}
      matrix-l2: ${{ steps.set-matrix-l2.outputs.matrix }}
      push: ${{ steps.set-push.outputs.push }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: Send Start Notification
        continue-on-error: true
        uses: gillouche/homelab-ci/actions/discord-notify@f5723a407eabc03e294948b3b1dd86c880c7c77a # main
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_GITHUB_ACTIONS }}
          status: info
          title: CI Pipeline Started
          url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          message: "Building images"
          fields: |
            [
              {"name": "Ref", "value": "${{ github.ref_name }}", "inline": true},
              {"name": "Commit", "value": "${{ github.sha }}", "inline": true},
              {"name": "Actor", "value": "${{ github.actor }}", "inline": true}
            ]

      - name: Setup Nix Cache Profile
        uses: gillouche/homelab-ci/actions/setup-aws-profile@f5723a407eabc03e294948b3b1dd86c880c7c77a # main
        with:
          profile: "nix"
          access-key-id: ${{ secrets.NIX_CACHE_ACCESS_KEY }}
          secret-access-key: ${{ secrets.NIX_CACHE_SECRET_KEY }}

      - name: Setup Nix Environment
        uses: gillouche/homelab-ci/actions/setup-nix-env@f5723a407eabc03e294948b3b1dd86c880c7c77a # main

      - name: Push Dev Environment to Nix Cache
        run: |
          { set +x; } 2>/dev/null
          echo "Pre-caching development environment..."
          nix copy --to "s3://nix-cache?endpoint=http://seaweedfs-s3.seaweedfs.svc.cluster.local:8333&scheme=http&profile=nix" .#devShells.x86_64-linux.default

      - name: Generate Matrix Level 1
        id: set-matrix-l1
        run: |
          { set +x; } 2>/dev/null
          MATRIX=$(python3 ci/generate_matrix.py --level 1)
          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

      - name: Generate Matrix Level 2
        id: set-matrix-l2
        run: |
          { set +x; } 2>/dev/null
          MATRIX=$(python3 ci/generate_matrix.py --level 2)
          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"
      
      - name: Determine Push Policy
        id: set-push
        run: |
          { set +x; } 2>/dev/null
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]] || [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "push=true" >> "$GITHUB_OUTPUT"
          else
            echo "push=false" >> "$GITHUB_OUTPUT"
          fi

  build-level-1:
    name: Build L1
    needs: prepare
    if: fromJson(needs.prepare.outputs.matrix-l1).include[0] != null
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix-l1) }}
    uses: ./.github/workflows/reusable-build.yaml
    with:
      image: ${{ matrix.image }}
      version: ${{ matrix.version }}
      push: ${{ needs.prepare.outputs.push == 'true' }}
    secrets: inherit

  build-level-2:
    name: Build L2
    needs: [prepare, build-level-1]
    if: |
      always() && 
      (needs.build-level-1.result == 'success' || needs.build-level-1.result == 'skipped') && 
      fromJson(needs.prepare.outputs.matrix-l2).include[0] != null
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix-l2) }}
    uses: ./.github/workflows/reusable-build.yaml
    with:
      image: ${{ matrix.image }}
      version: ${{ matrix.version }}
      push: ${{ needs.prepare.outputs.push == 'true' }}
    secrets: inherit

  notify-completion:
    name: Notify Completion
    runs-on: container-factory-runner
    if: always()
    needs: [prepare, build-level-1, build-level-2]
    steps:
      - name: Determine Status
        id: status
        run: |
          { set +x; } 2>/dev/null
          STATUS="success"
          MESSAGE="CI Pipeline Completed Successfully"

          if [[ "${{ needs.prepare.result }}" == "failure" || "${{ needs.prepare.result }}" == "cancelled" ]]; then
            STATUS="failure"
            MESSAGE="CI Pipeline Failed (Prepare)"
          elif [[ "${{ needs.build-level-1.result }}" == "failure" || "${{ needs.build-level-1.result }}" == "cancelled" ]]; then
            STATUS="failure"
            MESSAGE="CI Pipeline Failed (Level 1)"
          elif [[ "${{ needs.build-level-2.result }}" == "failure" || "${{ needs.build-level-2.result }}" == "cancelled" ]]; then
            STATUS="failure"
            MESSAGE="CI Pipeline Failed (Level 2)"
          fi

          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "message=$MESSAGE" >> $GITHUB_OUTPUT

      - name: Send Completion Notification
        continue-on-error: true
        uses: gillouche/homelab-ci/actions/discord-notify@f5723a407eabc03e294948b3b1dd86c880c7c77a # main
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_GITHUB_ACTIONS }}
          status: ${{ steps.status.outputs.status }}
          title: CI Pipeline Result
          url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          message: ${{ steps.status.outputs.message }}
          fields: |
            [
              {"name": "Ref", "value": "${{ github.ref_name }}", "inline": true},
              {"name": "Commit", "value": "${{ github.sha }}", "inline": true},
              {"name": "Actor", "value": "${{ github.actor }}", "inline": true}
            ]

