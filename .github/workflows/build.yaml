name: Build & Publish

on:
  push:
    branches: [ "**" ]
    paths:
      - "images/**"
      - "ci/**"
      - "tests/**"
      - ".github/workflows/**"
      - "Makefile"
      - "flake.nix"
      - "flake.lock"
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *' # Nightly rebuild at 3 AM UTC

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare:
    name: Prepare Environment
    runs-on: container-factory-runner # Required for internal network/cache access
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Nix Environment
        uses: ./.github/actions/setup-nix-env

      - name: Push Dev Environment to Nix Cache
        run: |
          echo "Pre-caching development environment..."
          export AWS_ACCESS_KEY_ID=$NIX_ACCESS_KEY_ID
          export AWS_SECRET_ACCESS_KEY=$NIX_SECRET_ACCESS_KEY
          # Copy flake dev shell dependencies to cache
          nix copy --to "s3://nix-cache?endpoint=http://seaweedfs-s3.seaweedfs.svc.cluster.local:8333&scheme=http" .#devShells.x86_64-linux.default

      - name: Generate Build Matrix
        id: set-matrix
        run: |
          MATRIX=$(python3 ci/generate-matrix.py)
          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

  build:
    name: Build ${{ matrix.image }}:${{ matrix.version }}
    needs: prepare
    runs-on: container-factory-runner # Using the runner with DIND sidecar
    timeout-minutes: 30
    concurrency:
      group: build-${{ matrix.image }}-${{ matrix.version }}-${{ github.ref }}
      cancel-in-progress: true
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    permissions:
      contents: read
      id-token: write # Required for cosign keyless signing
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1

      - name: Login to Nexus
        run: echo "$NEXUS_PASSWORD" | docker login nexus.gillouche.homelab -u "$NEXUS_USERNAME" --password-stdin

      - name: Setup Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3
        with:
          driver: docker-container # Required for multi-arch
          endpoint: unix:///var/run/docker.sock

      - name: Setup Nix Environment
        uses: ./.github/actions/setup-nix-env

      - name: Build and Push
        run: |
          nix develop \
            --extra-substituters "s3://nix-cache?endpoint=http://seaweedfs-s3.seaweedfs.svc.cluster.local:8333&scheme=http" \
            --extra-trusted-public-keys "cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=" \
            ./#default --command ./ci/build.sh "${{ matrix.image }}" "${{ matrix.version }}"
        env:
          NEXUS_REGISTRY: nexus.gillouche.homelab
          NEXUS_NAMESPACE: docker-hosted
          # Push only on main branch push or scheduled builds (not PRs or feature branches)
          PUSH_IMAGES: ${{ (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'schedule' }}
          SCAN_IMAGES: "true"
