name: Build & Publish

on:
  push:
    branches: [ "**" ]
    paths:
      - "images/**"
      - "ci/**"
      - ".github/workflows/**"
      - "Makefile"
      - "flake.nix"
      - "flake.lock"
      - "flake.lock"
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *' # Nightly rebuild at 3 AM UTC

jobs:
  build:
    name: Build Images
    if: github.repository_owner == 'gillouche'
    runs-on: container-factory-runner # Using the runner with DIND sidecar
    permissions:
      contents: read
      id-token: write # Required for cosign keyless signing
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1

      - name: Login to Nexus
        run: echo "${{ secrets.NEXUS_PASSWORD }}" | docker login nexus.gillouche.homelab -u "${{ secrets.NEXUS_USERNAME }}" --password-stdin

      - name: Setup Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3
        with:
          driver: docker-container # Required for multi-arch
          endpoint: unix:///var/run/docker.sock

      - name: Setup Nix
        uses: cachix/install-nix-action@V27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Build All Images
        run: |
          nix develop \
            --extra-substituters "s3://nix-cache?endpoint=http://seaweedfs-s3.seaweedfs.svc.cluster.local:8333&scheme=http" \
            --extra-trusted-public-keys "cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=" \
            ./#default --command make build-all
        env:
          NEXUS_REGISTRY: nexus.gillouche.homelab
          NEXUS_NAMESPACE: docker-hosted
          # Push only on main branch or scheduled builds
          PUSH_IMAGES: ${{ github.ref == 'refs/heads/main' || github.event_name == 'schedule' }}
          SCAN_IMAGES: "true"

      - name: Push to Nix Cache (Main Only)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Pushing build artifacts to Nix Cache..."
          export AWS_ACCESS_KEY_ID=${{ secrets.NIX_ACCESS_KEY_ID }}
          export AWS_SECRET_ACCESS_KEY=${{ secrets.NIX_SECRET_ACCESS_KEY }}
          nix copy --to "s3://nix-cache?endpoint=http://seaweedfs-s3.seaweedfs.svc.cluster.local:8333&scheme=http" ./#default
