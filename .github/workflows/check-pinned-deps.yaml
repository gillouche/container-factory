name: Check Pinned Dependencies

on:
  schedule:
    - cron: '0 2 * * *' # 2 AM UTC — 1h before nightly build
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-deps:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Check pinned dependencies
        id: check
        run: |
          nix develop ./#default --command python3 ci/check-pinned-deps.py > report.json
          echo "updates=$(jq '.updates | length' report.json)" >> "$GITHUB_OUTPUT"
          echo "warnings=$(jq '.warnings | length' report.json)" >> "$GITHUB_OUTPUT"
          cat report.json

      - name: Create PR via GitHub API
        if: steps.check.outputs.updates != '0'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python3 ci/create-update-pr.py report.json
          PR_URL=$(gh pr view auto-update/pinned-deps --json url -q '.url' 2>/dev/null || true)
          echo "pr_url=$PR_URL" >> "$GITHUB_ENV"

      - name: Notify Discord — updates available
        if: steps.check.outputs.updates != '0'
        env:
          SECURITY_NOTIFICATIONS_DISCORD: ${{ secrets.SECURITY_NOTIFICATIONS_DISCORD }}
        run: |
          [ -z "$SECURITY_NOTIFICATIONS_DISCORD" ] && echo "No webhook configured" && exit 0
          python3 -c "
          import json, os, urllib.request

          report = json.load(open('report.json'))
          pr_url = os.environ.get('pr_url', '')

          fields = []
          for u in report['updates']:
              if u['type'] == 'docker_digest':
                  fields.append({
                      'name': f\"{u['image']}:{u['tag']}\",
                      'value': f\"File: \`{u['file']}\`\nOld: \`{u['current_digest'][:19]}...\`\nNew: \`{u['latest_digest'][:19]}...\`\",
                      'inline': False
                  })
              elif u['type'] == 'action_pinned':
                  fields.append({
                      'name': f\"{u['action']}@{u['tag']}\",
                      'value': f\"File: \`{u['file']}\`\nOld: \`{u['current_sha'][:12]}\`\nNew: \`{u['latest_sha'][:12]}\`\",
                      'inline': False
                  })

          embed = {
              'title': 'Pinned Dependency Updates Available',
              'color': 15105570,
              'fields': fields,
          }
          if pr_url:
              embed['description'] = f'PR: {pr_url}'

          payload = json.dumps({'username': 'Dependency Checker', 'embeds': [embed]}).encode()
          req = urllib.request.Request(
              os.environ['SECURITY_NOTIFICATIONS_DISCORD'],
              data=payload,
              headers={'Content-Type': 'application/json', 'User-Agent': 'Container-Factory-DepCheck'}
          )
          urllib.request.urlopen(req)
          print('Discord notification sent')
          "

      - name: Notify Discord — unpinned dependencies only
        if: steps.check.outputs.updates == '0' && steps.check.outputs.warnings != '0'
        env:
          SECURITY_NOTIFICATIONS_DISCORD: ${{ secrets.SECURITY_NOTIFICATIONS_DISCORD }}
        run: |
          [ -z "$SECURITY_NOTIFICATIONS_DISCORD" ] && echo "No webhook configured" && exit 0
          python3 -c "
          import json, os, urllib.request

          report = json.load(open('report.json'))
          fields = []
          for w in report['warnings']:
              fields.append({
                  'name': w.get('action', w.get('image', 'unknown')),
                  'value': f\"File: \`{w['file']}\`\n{w['reason']}\",
                  'inline': False
              })

          embed = {
              'title': 'Unpinned Dependencies Detected',
              'color': 16711680,
              'description': 'The following dependencies are not pinned by digest/SHA.',
              'fields': fields,
          }

          payload = json.dumps({'username': 'Dependency Checker', 'embeds': [embed]}).encode()
          req = urllib.request.Request(
              os.environ['SECURITY_NOTIFICATIONS_DISCORD'],
              data=payload,
              headers={'Content-Type': 'application/json', 'User-Agent': 'Container-Factory-DepCheck'}
          )
          urllib.request.urlopen(req)
          print('Discord notification sent')
          "

      - name: Notify Discord — all up to date
        if: steps.check.outputs.updates == '0' && steps.check.outputs.warnings == '0'
        env:
          SECURITY_NOTIFICATIONS_DISCORD: ${{ secrets.SECURITY_NOTIFICATIONS_DISCORD }}
        run: |
          [ -z "$SECURITY_NOTIFICATIONS_DISCORD" ] && echo "No webhook configured" && exit 0
          python3 -c "
          import json, os, urllib.request

          report = json.load(open('report.json'))
          count = len(report['up_to_date'])

          embed = {
              'title': 'All Pinned Dependencies Up To Date',
              'color': 3066993,
              'description': f'{count} pinned dependencies checked — all digests and SHAs match upstream.',
          }

          payload = json.dumps({'username': 'Dependency Checker', 'embeds': [embed]}).encode()
          req = urllib.request.Request(
              os.environ['SECURITY_NOTIFICATIONS_DISCORD'],
              data=payload,
              headers={'Content-Type': 'application/json', 'User-Agent': 'Container-Factory-DepCheck'}
          )
          urllib.request.urlopen(req)
          print('Discord notification sent')
          "
