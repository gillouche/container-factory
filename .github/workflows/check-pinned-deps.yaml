name: Check Pinned Dependencies

on:
  schedule:
    - cron: '0 2 * * *' # 2 AM UTC — 1h before nightly build
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-deps:
    runs-on: container-factory-runner
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          token: ${{ secrets.PR_TOKEN }}

      - name: Setup Nix Environment
        uses: gillouche/homelab-ci/actions/setup-nix-env@08d173d21e18c50cfde249a7904ae8a62366c6fe # main
        with:
          access-key-id: ${{ secrets.NIX_CACHE_ACCESS_KEY }}
          secret-access-key: ${{ secrets.NIX_CACHE_SECRET_KEY }}

      - name: Check pinned dependencies
        id: check
        env:
          GH_TOKEN: ${{ secrets.PR_TOKEN }}
        run: |
          nix develop ./#default --command python3 ci/check_pinned_deps.py > report_pins.json

          if nix develop ./#default --command python3 ci/check_upstream_versions.py > report_versions.json; then
            echo "Version check complete."
          else
            echo '{"updates": []}' > report_versions.json
          fi

          echo "DEBUG: report_pins.json content:"
          cat report_pins.json
          echo "DEBUG: report_versions.json content:"
          cat report_versions.json

          nix develop ./#default --command jq --slurpfile v report_versions.json '.updates += ($v[0].updates // [])' report_pins.json > report.json
          
          echo "updates=$(jq '.updates | length' report.json)" >> "$GITHUB_OUTPUT"
          echo "warnings=$(jq '.warnings | length' report.json)" >> "$GITHUB_OUTPUT"
          cat report.json

      - name: Create PR via GitHub API
        if: steps.check.outputs.updates != '0'
        env:
          GH_TOKEN: ${{ secrets.PR_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          nix develop ./#default --command bash -c "
            set -e
            python3 ci/create_update_pr.py report.json
            PR_URL=\$(gh pr view auto-update/pinned-deps --json url -q '.url' 2>/dev/null || true)
            echo \"pr_url=\$PR_URL\" >> \"\$GITHUB_ENV\"
          "

      - name: Notify Discord — updates available
        if: steps.check.outputs.updates != '0'
        uses: gillouche/homelab-ci/actions/discord-notify@08d173d21e18c50cfde249a7904ae8a62366c6fe # main
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_SECURITY_NOTIFICATIONS }}
          title: "Pinned Dependency Updates Available"
          status: warning
          url: ${{ env.pr_url }}
          message: "A Pull Request has been created with pinned dependency updates."
          username: "Dependency Checker"

      - name: Generate Warning Fields
        if: steps.check.outputs.updates == '0' && steps.check.outputs.warnings != '0'
        id: report-warnings
        run: |
          nix develop ./#default --command python3 ci/format_discord_report.py report.json --type warnings > warning_fields.json
          echo 'fields<<EOF' >> $GITHUB_OUTPUT
          cat warning_fields.json >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Notify Discord — unpinned dependencies only
        if: steps.check.outputs.updates == '0' && steps.check.outputs.warnings != '0'
        uses: gillouche/homelab-ci/actions/discord-notify@08d173d21e18c50cfde249a7904ae8a62366c6fe # main
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_SECURITY_NOTIFICATIONS }}
          title: "Unpinned Dependencies Detected"
          status: failure
          message: "The following dependencies are not pinned."
          fields: ${{ steps.report-warnings.outputs.fields }}
          username: "Dependency Checker"

      - name: Generate Success Fields
        if: steps.check.outputs.updates == '0' && steps.check.outputs.warnings == '0'
        id: report-success
        run: |
          nix develop ./#default --command python3 ci/format_discord_report.py report.json --type success > success_fields.json
          echo 'fields<<EOF' >> $GITHUB_OUTPUT
          cat success_fields.json >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

      - name: Notify Discord — all up to date
        if: steps.check.outputs.updates == '0' && steps.check.outputs.warnings == '0'
        uses: gillouche/homelab-ci/actions/discord-notify@08d173d21e18c50cfde249a7904ae8a62366c6fe # main
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_SECURITY_NOTIFICATIONS }}
          title: "All Pinned Dependencies Up To Date"
          status: success
          message: "Dependency check completed successfully."
          fields: ${{ steps.report-success.outputs.fields }}
          username: "Dependency Checker"
