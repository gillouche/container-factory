name: Build Image Reusable

on:
  workflow_call:
    inputs:
      image:
        required: true
        type: string
      version:
        required: true
        type: string
      push:
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build-single:
    name: Build ${{ inputs.image }}:${{ inputs.version }}
    runs-on: container-factory-runner
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
      - name: Setup Nix Environment
        uses: gillouche/homelab-ci/actions/setup-nix-env@main
        with:
          access-key-id: ${{ secrets.NIX_CACHE_ACCESS_KEY }}
          secret-access-key: ${{ secrets.NIX_CACHE_SECRET_KEY }}


      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Setup temporary Nexus CA (Bootstrap)
        shell: bash
        run: |
          # 1. Update Runner shell trust (for Nix/Curl)
          sudo mkdir -p /usr/local/share/ca-certificates
          sudo cp images/actions-runner-homelab-nix/nexus-ca.crt /usr/local/share/ca-certificates/nexus-ca.crt
          
          if command -v trust >/dev/null; then
            sudo trust anchor /usr/local/share/ca-certificates/nexus-ca.crt
            echo "Updated trust using 'trust anchor'"
          elif command -v update-ca-certificates >/dev/null; then
            sudo update-ca-certificates
            echo "Updated trust using 'update-ca-certificates'"
          else
            echo "Warning: No CA update tool found, falling back to manual append for runner"
            for bundle in /etc/ssl/certs/ca-certificates.crt /etc/pki/tls/certs/ca-bundle.crt /etc/ssl/ca-bundle.pem /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem; do
              if [ -f "$bundle" ]; then
                sudo tee -a "$bundle" < images/actions-runner-homelab-nix/nexus-ca.crt > /dev/null
                echo "Appended to $bundle"
              fi
            done
          fi

          # 2. Update Docker Daemon trust (for docker login/push)
          # We pipe the certificate directly to a container to avoid volume mount issues between runner and dind
          cat images/actions-runner-homelab-nix/nexus-ca.crt | docker run --rm -i \
            -v /etc/docker/certs.d:/certs \
            busybox sh -c "mkdir -p /certs/nexus.gillouche.homelab && cat > /certs/nexus.gillouche.homelab/ca.crt"
          echo "Injected CA into Docker Daemon certificate store"

      - name: Build and Push
        id: build
        run: |
          { set +x; } 2>/dev/null
          # Login to Nexus first
          echo "${{ secrets.NEXUS_PASSWORD }}" | docker login nexus.gillouche.homelab -u "${{ secrets.NEXUS_USERNAME }}" --password-stdin

          nix develop ./#default --command ./ci/build.sh "${{ inputs.image }}" "${{ inputs.version }}"
        env:
          SMOKE_TEST: "false"
          NEXUS_REGISTRY: nexus.gillouche.homelab
          NEXUS_NAMESPACE: docker-hosted
          PUSH_IMAGES: ${{ inputs.push }}
          SCAN_IMAGES: true
          NIX_ACCESS_KEY_ID: ${{ secrets.NIX_CACHE_ACCESS_KEY }}
          NIX_SECRET_ACCESS_KEY: ${{ secrets.NIX_CACHE_SECRET_KEY }}
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}

      - name: Trivy Scan
        uses: gillouche/homelab-ci/actions/trivy-scan@main
        with:
          image: ${{ steps.build.outputs.image_full }}
          trivyignore: images/${{ inputs.image }}/.trivyignore
          discord-webhook: ${{ secrets.DISCORD_WEBHOOK_SECURITY }}

      - name: Push Notification
        if: steps.build.outputs.pushed == 'true'
        uses: gillouche/homelab-ci/actions/push-notify@main
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_SECURITY }}
          image: ${{ inputs.image }}
          tag: ${{ inputs.version }}
          digest: ${{ steps.build.outputs.digest }}
