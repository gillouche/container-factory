name: Build Image Reusable

on:
  workflow_call:
    inputs:
      image:
        required: true
        type: string
      version:
        required: true
        type: string
      push:
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build-single:
    name: Build ${{ inputs.image }}:${{ inputs.version }}
    runs-on: container-factory-runner
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
      - name: Setup Nix Environment
        uses: gillouche/homelab-ci/actions/setup-nix-env@main
        with:
          access-key-id: ${{ secrets.NIX_CACHE_ACCESS_KEY }}
          secret-access-key: ${{ secrets.NIX_CACHE_SECRET_KEY }}

      - name: Build and Push
        id: build
        run: |
          { set +x; } 2>/dev/null
          # Login to Nexus first
          echo "${{ secrets.NEXUS_PASSWORD }}" | docker login nexus.gillouche.homelab -u "${{ secrets.NEXUS_USERNAME }}" --password-stdin

          nix develop \
            --extra-substituters "s3://nix-cache?endpoint=http://seaweedfs-s3.seaweedfs.svc.cluster.local:8333&scheme=http" \
            --extra-trusted-public-keys "cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=" \
            ./#default --command ./ci/build.sh "${{ inputs.image }}" "${{ inputs.version }}"
        env:
          NEXUS_REGISTRY: nexus.gillouche.homelab
          NEXUS_NAMESPACE: docker-hosted
          PUSH_IMAGES: ${{ inputs.push }}
          SCAN_IMAGES: true
          NIX_ACCESS_KEY_ID: ${{ secrets.NIX_CACHE_ACCESS_KEY }}
          NIX_SECRET_ACCESS_KEY: ${{ secrets.NIX_CACHE_SECRET_KEY }}
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}

      - name: Trivy Scan
        uses: gillouche/homelab-ci/actions/trivy-scan@main
        with:
          image: ${{ steps.build.outputs.image_full }}
          trivyignore: images/${{ inputs.image }}/.trivyignore
          discord-webhook: ${{ secrets.DISCORD_WEBHOOK_SECURITY }}

      - name: Push Notification
        if: steps.build.outputs.pushed == 'true'
        uses: gillouche/homelab-ci/actions/push-notify@main
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_SECURITY }}
          image: ${{ inputs.image }}
          tag: ${{ inputs.version }}
          digest: ${{ steps.build.outputs.digest }}
