name: Build Image Reusable

on:
  workflow_call:
    inputs:
      image:
        required: true
        type: string
      version:
        required: true
        type: string
      push:
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  build-single:
    name: Build ${{ inputs.image }}:${{ inputs.version }}
    runs-on: container-factory-runner
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
      - name: Checkout Homelab CI
        uses: actions/checkout@v4
        with:
          repository: gillouche/homelab-ci
          path: .homelab-ci
      - name: Load Runner Secrets
        run: |
          echo "::add-mask::$DISCORD_WEBHOOK_GITHUB_ACTIONS"
          echo "::add-mask::$DISCORD_WEBHOOK_SECURITY_NOTIFICATIONS"
          echo "::add-mask::$NIX_ACCESS_KEY_ID"
          echo "::add-mask::$NIX_SECRET_ACCESS_KEY"
          
          echo "DISCORD_WEBHOOK_GITHUB_ACTIONS=$DISCORD_WEBHOOK_GITHUB_ACTIONS" >> $GITHUB_ENV
          echo "DISCORD_WEBHOOK_SECURITY_NOTIFICATIONS=$DISCORD_WEBHOOK_SECURITY_NOTIFICATIONS" >> $GITHUB_ENV
          echo "NEXUS_USERNAME=$NEXUS_USERNAME" >> $GITHUB_ENV
          echo "NEXUS_PASSWORD=$NEXUS_PASSWORD" >> $GITHUB_ENV

      - name: Login to Nexus
        run: echo "$NEXUS_PASSWORD" | docker login nexus.gillouche.homelab -u "$NEXUS_USERNAME" --password-stdin

      - name: Install Nexus CA on Host
        run: |
          sudo mkdir -p /usr/local/share/ca-certificates
          sudo cp nexus-ca.crt /usr/local/share/ca-certificates/nexus-ca.crt
          sudo update-ca-certificates

      - name: Setup Buildx with CA
        run: |
          CERT_PATH="${{ github.workspace }}/nexus-ca.crt"
          
          # 1. Create builder with default config
          docker buildx create \
            --name container-factory-builder \
            --driver docker-container \
            --driver-opt network=host \
            --buildkitd-flags '--allow-insecure-entitlement security.insecure' \
            --bootstrap \
            --use
          
          # 2. Inject certificate into the running builder container system trust store
          CONTAINER_NAME="buildx_buildkit_container-factory-builder0"
          
          # Ensure target directory exists (Alpine/Debian compatible path)
          docker exec "$CONTAINER_NAME" mkdir -p /usr/local/share/ca-certificates
          
          docker cp "$CERT_PATH" "$CONTAINER_NAME":/usr/local/share/ca-certificates/nexus-ca.crt
          
          # Update CA store
          if docker exec "$CONTAINER_NAME" sh -c "command -v update-ca-certificates >/dev/null"; then
            docker exec "$CONTAINER_NAME" update-ca-certificates
          else
            # Fallback for minimal images: append to bundle
            docker exec "$CONTAINER_NAME" sh -c "cat /usr/local/share/ca-certificates/nexus-ca.crt >> /etc/ssl/certs/ca-certificates.crt"
          fi
          
          # 3. Restart buildkit to pick up new root CAs
          docker restart "$CONTAINER_NAME"
          
          # 4. Wait for it to be ready
          docker buildx inspect --bootstrap

      - name: Setup Nix Environment
        uses: gillouche/homelab-ci/actions/setup-nix-env@main



      - name: Build and Push
        run: |
          nix develop \
            --extra-substituters "s3://nix-cache?endpoint=http://seaweedfs-s3.seaweedfs.svc.cluster.local:8333&scheme=http" \
            --extra-trusted-public-keys "cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY=" \
            ./#default --command ./ci/build.sh "${{ inputs.image }}" "${{ inputs.version }}"
        env:
          NEXUS_REGISTRY: nexus.gillouche.homelab
          NEXUS_NAMESPACE: docker-hosted
          PUSH_IMAGES: ${{ inputs.push }}
          SCAN_IMAGES: true
          # Webhooks are picked up from env by the script if exported or passed explicitly?
          # ci/build.sh line 114: DISCORD_WEBHOOK="$DISCORD_WEBHOOK_SECURITY_NOTIFICATIONS" ...
          # So we need them in env. We set them in "Load Runner Secrets".




